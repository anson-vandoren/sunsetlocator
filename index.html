<!DOCTYPE html>
<html>
  <head>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
      integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
      crossorigin=""
    />
    <link rel="stylesheet" href="./style.css" />
    <script
      src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
      integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
      crossorigin=""
    ></script>
    <script src="./luxon.min.js"></script>
    <script src="./index.js"></script>
    <script src="./tz.js"></script>
  </head>
  <body>
    <div id="mapid"></div>
    <input type="date" id="dt" onchange="updateDate(event)" />
    <script>
      // var startPoint = [37.626, -122.149];
      // var myMap = L.map("mapid").setView(startPoint, 11);
      // L.tileLayer(
      //   "https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",
      //   {
      //     attribution:
      //       'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
      //     maxZoom: 18,
      //     id: "mapbox.streets",
      //     accessToken:
      //       "pk.eyJ1IjoiYW5zb252YW5kb3JlbiIsImEiOiJjazB0cWh3dGEwZzloM250Y3J6aHRlc3ZrIn0.YP5RGsqokNVVyyJeDbRWyA"
      //   }
      // ).addTo(myMap);
      // var marker = L.marker(dest).addTo(myMap);
      // draw circle to horizon for observer=1.7m
      // with distant point at 10m, 50m
      const dist10m = 3.57 * (Math.sqrt(1.7) + Math.sqrt(10));
      const dist20m = 3.57 * (Math.sqrt(1.7) + Math.sqrt(20));
      const dist50m = 3.57 * (Math.sqrt(1.7) + Math.sqrt(50));

      // var horiz10m = L.circle(startPoint, {
      //   color: "red",
      //   fillColor: "#f03",
      //   fillOpacity: 0,
      //   weight: 2,
      //   radius: dist10m * 1000
      // }).addTo(myMap);
      // horiz10m.bindPopup(
      //   "An object 10m tall will be just visible on the horizon this far away"
      // );

      // var polygon = L.polygon([
      //   startPoint,
      //   dest,
      //   [startPoint[0], dest[1]]
      // ]).addTo(myMap);

      // marker.bindPopup("<b>Hello world!</b><br>I am a popup.").openPopup();

      // var popup = L.popup()
      //   .setLatLng([37.7, -122.4])
      //   .setContent("I am a standalone popup.")
      //   .openOn(myMap);

      /* var alertPop = latitude.popup();
      function onMapClick(e) {
        alertPop
          .setLatLng(e.latlng)
          .setContent('you clicked: ' + e.latlng.toString())
          .openOn(myMap);
      }

      myMap.on('click', onMapClick); */
      let observerLat = -44.67396323337423;
      let observerLong = -192.0743179321289;
      let startPoint = [observerLat, observerLong];
      var myMap = L.map("mapid").setView(startPoint, 12);
      // L.tileLayer(
      //   "https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",
      //   {
      //     attribution:
      //       'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
      //     maxZoom: 18,
      //     id: "mapbox.streets",
      //     accessToken:
      //       "pk.eyJ1IjoiYW5zb252YW5kb3JlbiIsImEiOiJjazB0cWh3dGEwZzloM250Y3J6aHRlc3ZrIn0.YP5RGsqokNVVyyJeDbRWyA"
      //   }
      // ).addTo(myMap);
      L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          'Map data © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
      }).addTo(myMap);

      const pressure = 1013;
      const temp = 27;
      const elev = 10;
      var date = luxon.DateTime.local(2019, 6, 21, 20, 53);
      let spa = new SPA(date, observerLat, observerLong, elev, temp, pressure);

      let sunsetTime = sunRiseSetTransit(spa).sunSet;
      spa = new SPA(
        sunsetTime,
        observerLat,
        observerLong,
        elev,
        temp,
        pressure
      );
      console.log(spa.azimuth);
      console.log(spa.e);
      let spaObsPoint = L.marker(spa.latlng).addTo(myMap);
      var horiz20m = L.circle(spa.latlng, {
        color: "red",
        fillColor: "#f03",
        fillOpacity: 0,
        weight: 2,
        radius: dist20m * 1000
      }).addTo(myMap);
      let sunsetLatLng = latLngFromAzimuth(
        [observerLat, observerLong],
        dist20m * 1000,
        spa.azimuth,
        0
      );
      console.log(sunsetLatLng);
      const sunsetPoint = L.marker(sunsetLatLng).addTo(myMap);
      const connector = L.polyline(
        [[observerLat, observerLong], sunsetLatLng],
        {
          color: "blue",
          weight: 1
        }
      ).addTo(myMap);

      function onMapClick(e) {
        console.log("date=", date.toString());
        const limitLatLng = latlng =>
          L.latLng(
            limit_degrees180pm(latlng.lat),
            limit_degrees180pm(latlng.lng)
          );
        const newLatLng = e.latlng;

        console.log("raw latlong", newLatLng);
        console.log(newLatLng);
        startPoint = newLatLng;
        // TODO: get new time zone and apply
        const limitedLatLng = limitLatLng(newLatLng);
        const newTz = tzlookup(limitedLatLng.lat, limitedLatLng.lng);
        date = date.setZone(newTz, { keepLocalTime: true });
        console.log(newTz);
        spa = new SPA(date, newLatLng.lat, newLatLng.lng, elev, temp, pressure);
        sunsetTime = sunRiseSetTransit(spa).sunSet;
        spa = new SPA(
          sunsetTime,
          newLatLng.lat,
          newLatLng.lng,
          elev,
          temp,
          pressure
        );
        sunsetTime = sunRiseSetTransit(spa).sunSet;
        spaObsPoint.setLatLng(newLatLng);
        horiz20m.setLatLng(newLatLng);

        sunsetLatLng = latLngFromAzimuth(
          [newLatLng.lat, newLatLng.lng],
          dist20m * 1000,
          spa.azimuth,
          0
        );
        console.log(newLatLng.lat, newLatLng.lng, sunsetLatLng);
        sunsetPoint.setLatLng(sunsetLatLng);
        connector.setLatLngs([newLatLng, sunsetLatLng]);
        console.log(
          "New sunset: ",
          sunsetTime.toString(),
          ", Sunset Azimuth: ",
          spa.azimuth
        );
      }

      myMap.on("click", onMapClick);
      function updateDate(e) {
        const dateStr = e.target.value;
        date = new luxon.DateTime.fromFormat(dateStr, "yyyy-MM-dd", {
          zone: date.zone
        });
        onMapClick({ latlng: new L.LatLng(spa.latitude, spa.longitude) });
      }
      const datePicker = document.getElementById("dt");
      if (datePicker) {
        datePicker.value = date.toFormat("yyyy-MM-dd");
      }
    </script>
  </body>
</html>
